<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
      style-src 'self' https://fonts.googleapis.com 'unsafe-inline';
      connect-src 'self' https://rpc.testnet.soniclabs.com;
      font-src 'self' https://fonts.gstatic.com;
      img-src 'self' data: https://*.ardrive.net;
    "
  />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Power of 10 (Testnet)</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --bg-dark: #0a0a1f;
      --neon: #00ffe1;
      --neon-dim: rgba(0,255,225,0.2);
      --text-light: #e0e0e0;
      --card-bg: rgba(255,255,255,0.05);
      --radius: 16px;
      --gap: 1.5rem;
      --transition: 0.3s ease;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: radial-gradient(circle at center, #1a1a3d, #0a0a1f);
      color: var(--text-light);
      font-family: 'Roboto', sans-serif;
      padding: var(--gap);
      line-height: 1.4;
    }
    .brand {
      text-align: center;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--neon);
      text-shadow: 0 0 8px var(--neon), 0 0 16px var(--neon);
      margin-bottom: var(--gap);
      letter-spacing: 2px;
    }
    #wallet-button {
      position: fixed;
      top: var(--gap);
      right: var(--gap);
      padding: .6rem 1.2rem;
      border: 2px solid var(--neon);
      background: transparent;
      color: var(--neon);
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      transition: background var(--transition), color var(--transition);
      z-index: 10;
    }
    #wallet-button:hover { background: var(--neon-dim); color: #fff; }
    .banner-wrapper {
      max-width: 300px;
      margin: 0 auto calc(var(--gap) * 1.5);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }
    .banner-wrapper img { display: block; width: 100%; height: auto; }
    .lower-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: var(--gap);
    }
    .box {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      padding: var(--gap);
      display: flex;
      flex-direction: column;
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .box:hover {
      transform: translateY(-6px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    }
    h1 {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--neon);
      text-align: center;
      margin-bottom: 1rem;
      text-shadow: 0 0 4px var(--neon);
    }
    label {
      font-weight: 500;
      margin-bottom: .5rem;
      color: var(--text-light);
    }
    select, input {
      width: 100%;
      padding: .6rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
      color: var(--text-light);
      font-size: 1rem;
      transition: border var(--transition);
    }
    select:focus, input:focus { outline: none; border-color: var(--neon); }
    button {
      padding: .75rem;
      border: 2px solid var(--neon);
      background: transparent;
      color: var(--neon);
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background var(--transition), color var(--transition);
    }
    button:hover { background: var(--neon-dim); color: #fff; }
    .form-group {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .info {
      text-align: center;
      margin: .75rem 0;
      font-size: .95rem;
      color: var(--text-light);
    }
    #status, #stake-status {
      text-align: center;
      margin-top: .5rem;
      min-height: 1.2em;
      font-size: .9rem;
      color: var(--neon);
    }
    .socials {
      text-align: center;
      margin-top: var(--gap);
    }
    .socials a { margin: 0 .5rem; display: inline-block; }
    .socials img {
      width: 28px;
      height: 28px;
      filter: drop-shadow(0 0 4px var(--neon));
    }
  </style>
</head>
<body>
  <div class="brand">Power of 10 (Testnet)</div>
  <button id="wallet-button">Connect Wallet</button>

  <div class="banner-wrapper">
    <img
      src="https://d5z5gg6ru5enr7l6wb6sdgcjdmju3qtap3eo4du77bry4udg2jiq.ardrive.net/H3PTG9GnSNj9frB9IZhJGxNNwmB-yO4On_hjjlBm0lE"
      alt="Power of 10 Banner"
    />
  </div>

  <div class="lower-section">
    <!-- Mint Card -->
    <div class="box">
      <h1>Mint NFT</h1>
      <div class="form-group">
        <label for="power-select">Select Power</label>
        <select id="power-select">
          <option value="1" selected>1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
        </select>
        <button id="mint-button">Mint Now</button>
      </div>
      <div id="status"></div>
    </div>

    <!-- Staking Card -->
    <div class="box">
      <h1>Stake &amp; Unstake</h1>
      <div class="form-group">
        <label for="stake-select">Your NFTs</label>
        <select id="stake-select" multiple size="5"></select>
        <button id="stake-button">Stake Selected</button>
      </div>
      <div class="form-group">
        <label for="unstake-select">Staked NFTs</label>
        <select id="unstake-select" multiple size="5"></select>
        <button id="unstake-button">Unstake Selected</button>
      </div>
      <div class="info" id="staked-info">Staked NFTs: 0 | Power: 0</div>
      <div class="info" id="pending-rewards">Rewards: 0 S</div>
      <button id="claim-button">Claim Rewards</button>
      <div id="stake-status"></div>
    </div>

    <!-- Coming Soon Card -->
    <div class="box">
      <h1>Coming Soon</h1>
      <p class="info">Redeem utilities launching shortly!</p>
    </div>
  </div>

  <div class="socials">
    <a href="#" id="docs-link"><img src="PATH_TO_BOOK_ICON" alt="Docs"></a>
    <a href="#" id="x-link"><img src="PATH_TO_X_ICON" alt="X"></a>
    <a href="#" id="telegram-link"><img src="PATH_TO_TELEGRAM_ICON" alt="Telegram"></a>
  </div>

  <script type="module">
    import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js';

    // Sonic Testnet network params
    const TESTNET = {
      chainId: '0x3909',
      chainName: 'Sonic Testnet',
      rpcUrls: ['https://rpc.testnet.soniclabs.com'],
      nativeCurrency: { name: 'Sonic', symbol: 'S', decimals: 18 },
      blockExplorerUrls: ['https://testnet.sonicscan.org']
    };

    // Contract addresses
    const NFT_ADDRESS     = '0x26DFE5fD6820adEc0e901D4CCFef490ddf58D79C';
    const STAKING_ADDRESS = '0x72894C00416CaEEDe08e791aCfA565293ff38CcC';

    // NFT ABI with feeForPower/mint + balance & optional enumerable
    const NFT_ABI = [
      'function feeForPower(uint8) view returns (uint256)',
      'function mint(uint8) payable',
      'function balanceOf(address) view returns (uint256)',
      'function tokenOfOwnerByIndex(address,uint256) view returns (uint256)'
    ];

    // Staking ABI including view helpers
    const STAKING_ABI = [
      'function stake(uint256[])',
      'function unstake(uint256[])',
      'function claimRewards()',
      'function stakedTokensOf(address) view returns (uint256[])',
      'function pendingRewards(address) view returns (uint256)',
      'function totalPowerStaked(address) view returns (uint256)'
    ];

    let provider, signer, account;
    let nftContract, stakingContract;

    // 1) Connect wallet & switch network
    async function connectWallet() {
      if (!window.ethereum) {
        return alert('Please install a Web3 wallet');
      }

      // 1a) Request accounts
      await window.ethereum.request({ method: 'eth_requestAccounts' });

      // 1b) Setup provider + signer
      provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
      signer   = provider.getSigner();
      account  = await signer.getAddress();

      // 1c) Ensure on Sonic Testnet
      await switchToTestnet();
      const net = await provider.getNetwork();
      if (net.chainId !== parseInt(TESTNET.chainId, 16)) {
        document.getElementById('status').textContent =
          'Wrong network. Switch to Sonic Testnet';
        return;
      }

      // 1d) Show only last 4 chars of address
      const last4 = account.slice(-4);
      document.getElementById('wallet-button').textContent = '…' + last4;
      document.getElementById('status').textContent = 'Connected to Testnet';

      // 1e) Instantiate contracts
      nftContract     = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);
      stakingContract = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);

      attachHandlers();
      await refreshUI();
    }

    // 2) Add / switch network in wallet
    async function switchToTestnet() {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: TESTNET.chainId }]
        });
      } catch (err) {
        if (err.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [TESTNET]
          });
        }
      }
    }

    // 3) Wire up mint / stake / unstake / claim
    function attachHandlers() {
      document.getElementById('mint-button').onclick = async () => {
        const power = +document.getElementById('power-select').value;
        try {
          const cost = await nftContract.feeForPower(power);
          const tx   = await nftContract.mint(power, { value: cost });
          document.getElementById('status').textContent = 'Minting…';
          await tx.wait();
          document.getElementById('status').textContent = 'Mint successful!';
        } catch (e) {
          document.getElementById('status').textContent = e.message;
          return;
        }
        // Refresh UI but don’t overwrite mint status on error
        refreshUI().catch(console.warn);
      };

      document.getElementById('stake-button').onclick = async () => {
        const ids = Array.from(
          document.getElementById('stake-select').selectedOptions
        ).map(o => +o.value);
        if (!ids.length) return;
        try {
          document.getElementById('stake-status').textContent = 'Staking…';
          const tx = await stakingContract.stake(ids);
          await tx.wait();
          document.getElementById('stake-status').textContent = 'Staked!';
          await refreshUI();
        } catch (e) {
          document.getElementById('stake-status').textContent = e.message;
        }
      };

      document.getElementById('unstake-button').onclick = async () => {
        const ids = Array.from(
          document.getElementById('unstake-select').selectedOptions
        ).map(o => +o.value);
        if (!ids.length) return;
        try {
          document.getElementById('stake-status').textContent = 'Unstaking…';
          const tx = await stakingContract.unstake(ids);
          await tx.wait();
          document.getElementById('stake-status').textContent = 'Unstaked!';
          await refreshUI();
        } catch (e) {
          document.getElementById('stake-status').textContent = e.message;
        }
      };

      document.getElementById('claim-button').onclick = async () => {
        try {
          document.getElementById('stake-status').textContent = 'Claiming…';
          const tx = await stakingContract.claimRewards();
          await tx.wait();
          document.getElementById('stake-status').textContent = 'Claimed!';
          await refreshUI();
        } catch (e) {
          document.getElementById('stake-status').textContent = e.message;
        }
      };
    }

    // 4) Refresh all lists & stats
    async function refreshUI() {
      await populateOwned();
      await populateStaked();
      await updateStats();
    }

    // 4a) Get your owned IDs, fallback to Transfer events if enumerable missing
    async function getOwnedTokenIds() {
      try {
        const bal = await nftContract.balanceOf(account);
        const ids = [];
        for (let i = 0; i < bal; i++) {
          const id = await nftContract.tokenOfOwnerByIndex(account, i);
          ids.push(id.toString());
        }
        return ids;
      } catch {
        // fallback: read mint Transfer(address(0), you)
        const zero = ethers.constants.AddressZero;
        const filter = nftContract.filters.Transfer(zero, account);
        const logs = await nftContract.queryFilter(filter, 0, 'latest');
        return logs.map(log => log.args.tokenId.toString());
      }
    }

    // 4b) Fill “Your NFTs”
    async function populateOwned() {
      const sel = document.getElementById('stake-select');
      sel.innerHTML = '';
      const ids = await getOwnedTokenIds();
      ids.forEach(id => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = `#${id}`;
        sel.append(opt);
      });
    }

    // 4c) Fill “Staked NFTs”
    async function populateStaked() {
      const sel = document.getElementById('unstake-select');
      sel.innerHTML = '';
      const staked = await stakingContract.stakedTokensOf(account);
      staked.forEach(id => {
        const opt = document.createElement('option');
        opt.value = id.toString();
        opt.textContent = `#${id}`;
        sel.append(opt);
      });
    }

    // 4d) Update counts, power & rewards
    async function updateStats() {
      const stakedArr = await stakingContract.stakedTokensOf(account);
      const totalPower  = await stakingContract.totalPowerStaked(account);
      const rewards     = await stakingContract.pendingRewards(account);

      document.getElementById('staked-info').textContent =
        `Staked NFTs: ${stakedArr.length} | Power: ${totalPower}`;
      document.getElementById('pending-rewards').textContent =
        `Rewards: ${ethers.utils.formatUnits(rewards, 18)} S`;
    }

    document.getElementById('wallet-button').onclick = connectWallet;
  </script>
</body>
</html>
