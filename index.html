<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>wagmi zero-build: Injected + WalletConnect v2</title>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; color:#0f172a; }
    body { padding:20px; max-width:900px; margin:0 auto; }
    h1 { font-size:1.25rem; margin:0 0 12px 0; }
    .card { border:1px solid #e6e8eb; padding:14px; border-radius:10px; margin-bottom:12px; background:#fff; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    button { padding:8px 12px; border-radius:8px; border:1px solid #d1d5db; background:#f8fafc; cursor:pointer; }
    button[disabled] { opacity:0.6; cursor:default; }
    input { padding:8px; border-radius:8px; border:1px solid #e6e8eb; width:100%; }
    pre { background:#f6f8fa; padding:12px; border-radius:8px; white-space:pre-wrap; word-break:break-word; }
    small { color:#475569; }
  </style>
</head>
<body>
  <h1>wagmi zero-build — Connect Wallets (Injected + WalletConnect v2)</h1>

  <div id="root"></div>

  <script type="module">
    // NOTE: Pin versions to avoid breaking changes.
    import React from 'https://esm.sh/react@18.2.0';
    import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
    import {
      WagmiConfig,
      createClient,
      configureChains,
      useAccount,
      useConnect,
      useDisconnect,
      useNetwork,
      useBalance
    } from 'https://esm.sh/wagmi@1.2.0';

    import { publicProvider } from 'https://esm.sh/wagmi@1.2.0/providers/public';
    import { mainnet, goerli } from 'https://esm.sh/wagmi@1.2.0/chains';

    import { InjectedConnector } from 'https://esm.sh/wagmi@1.2.0/connectors/injected';
    import { WalletConnectConnector } from 'https://esm.sh/wagmi@1.2.0/connectors/walletConnect';

    // Configure chains and provider (readonly)
    const { provider } = configureChains([mainnet], [publicProvider()]);

    // Replace with your WalletConnect v2 projectId
    const WALLETCONNECT_PROJECT_ID = 'YOUR_WALLETCONNECT_PROJECT_ID';

    // Create wagmi client with Injected and WalletConnect v2 connectors
    const client = createClient({
      autoConnect: true,
      provider,
      connectors: [
        new InjectedConnector({
          options: { shimDisconnect: true },
        }),
        new WalletConnectConnector({
          options: {
            projectId: WALLETCONNECT_PROJECT_ID,
            showQrModal: true,
            metadata: {
              name: 'wagmi Zero-Build DApp',
              description: 'Example using Injected + WalletConnect v2',
              url: window.location.origin,
              icons: [],
            },
          },
        }),
      ],
    });

    // Small UI components using React.createElement to avoid JSX tooling
    function ConnectorButtons() {
      const { address, connector, isConnected } = useAccount();
      const { connect, connectors, error: connectError, isLoading } = useConnect();
      const { disconnect } = useDisconnect();
      const network = useNetwork();
      const balanceQ = useBalance({ address });

      return React.createElement('div', { className: 'card' }, 
        React.createElement('div', null,
          React.createElement('div', { className: 'row' },
            !isConnected && connectors.map(c =>
              React.createElement('button', {
                key: c.id,
                onClick: () => connect({ connector: c }),
                disabled: isLoading
              }, `Connect ${c.name}`)
            ),
            isConnected && React.createElement('div', { className: 'row' },
              React.createElement('div', null, React.createElement('strong', null, 'Connected: '), address),
              React.createElement('div', null, React.createElement('strong', null, 'via '), connector?.name || '—'),
              React.createElement('button', { onClick: disconnect }, 'Disconnect')
            )
          ),
          React.createElement('div', null,
            React.createElement('small', null, network.chain ? `Chain: ${network.chain.name} (id ${network.chain.id})` : 'Chain: —'),
            React.createElement('div', null, React.createElement('small', null, balanceQ.data ? `Balance: ${balanceQ.data.formatted} ${balanceQ.data.symbol}` : 'Balance: —'))
          ),
          connectError && React.createElement('pre', null, `Connect error: ${connectError.message}`)
        )
      );
    }

    function ContractTools() {
      // Minimal contract read/tx UI using window.ethereum signer if available
      const { address, isConnected } = useAccount();
      const [contractAddr, setContractAddr] = React.useState('');
      const [log, setLog] = React.useState('');

      function appendLog(msg) {
        setLog(prev => `${new Date().toISOString()}  ${msg}\n\n` + prev);
      }

      async function readTotalPower() {
        if (!contractAddr) { appendLog('Set contract address'); return; }
        try {
          // Minimal ABI for totalPower(address) view returns (uint256)
          const abi = ['function totalPower(address) view returns (uint256)'];
          // Use ethers from the injected provider via window.ethereum
          if (!window.ethereum) { appendLog('No injected provider available for read'); return; }
          const { ethers } = await import('https://esm.sh/ethers@6.9.0');
          const provider = new ethers.BrowserProvider(window.ethereum);
          const contract = new ethers.Contract(contractAddr, abi, provider);
          const target = address || prompt('Enter address to query totalPower for:');
          if (!target) return;
          const val = await contract.totalPower(target);
          appendLog(`totalPower(${target}) = ${val.toString()}`);
        } catch (err) {
          appendLog('Read error: ' + (err?.message || err));
        }
      }

      async function attemptUnstakeAll() {
        if (!contractAddr) { appendLog('Set contract address'); return; }
        if (!window.ethereum) { appendLog('No injected provider available to send tx'); return; }
        try {
          const { ethers } = await import('https://esm.sh/ethers@6.9.0');
          const provider = new ethers.BrowserProvider(window.ethereum);
          const signer = await provider.getSigner();
          const abi = ['function unstakeAll() external'];
          const contract = new ethers.Contract(contractAddr, abi, signer);

          appendLog('Estimating gas for unstakeAll...');
          try {
            const estimate = await contract.estimateGas.unstakeAll();
            appendLog('Gas estimate: ' + estimate.toString());
          } catch (estErr) {
            appendLog('Gas estimation failed: ' + (estErr?.message || estErr));
            // try to extract revert data if present
            const data = estErr?.error?.data || estErr?.data;
            if (data) appendLog('Revert data: ' + data);
            return;
          }

          appendLog('Sending unstakeAll tx...');
          const tx = await contract.unstakeAll();
          appendLog('Tx sent: ' + tx.hash);
          const receipt = await tx.wait();
          appendLog('Tx mined, status: ' + receipt.status);
        } catch (err) {
          appendLog('Tx error: ' + (err?.message || err));
        }
      }

      return React.createElement('div', { className: 'card' },
        React.createElement('div', { className: 'row' },
          React.createElement('input', {
            placeholder: 'Contract address (0x...)',
            value: contractAddr,
            onInput: e => setContractAddr(e.target.value)
          })
        ),
        React.createElement('div', { className: 'row' },
          React.createElement('button', { onClick: readTotalPower }, 'Read totalPower(address)'),
          React.createElement('button', { onClick: attemptUnstakeAll }, 'Estimate + Send unstakeAll')
        ),
        React.createElement('div', null, React.createElement('pre', null, log || 'Logs will appear here'))
      );
    }

    function App() {
      return React.createElement('div', null,
        React.createElement('div', { className: 'card' },
          React.createElement('strong', null, 'Instructions:'),
          React.createElement('div', null, '1) Replace WALLETCONNECT_PROJECT_ID in the script with your projectId.'),
          React.createElement('div', null, '2) Open the page and use Connect buttons to use MetaMask, Rabby (injected), or WalletConnect (QR/modal).'),
          React.createElement('div', null, '3) Enter a contract address to read or attempt transaction (estimate shows revert data if gas estimation failed).')
        ),
        React.createElement(ConnectorButtons),
        React.createElement(ContractTools)
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(WagmiConfig, { client }, React.createElement(App)));
  </script>
</body>
</html>
