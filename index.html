<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
      style-src  'self' https://fonts.googleapis.com 'unsafe-inline';
      connect-src 'self' https://rpc.testnet.soniclabs.com;
      font-src   'self' https://fonts.gstatic.com;
      img-src    'self' data: https://*.ardrive.net;
    "
  />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InFlow</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --bg-dark: #0a0a1f;
      --neon: #00ffe1;
      --neon-dim: rgba(0,255,225,0.2);
      --text-light: #e0e0e0;
      --card-bg: rgba(255,255,255,0.05);
      --radius: 16px;
      --gap: 1.5rem;
      --transition: 0.3s ease;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: radial-gradient(circle at center, #1a1a3d, #0a0a1f);
      color: var(--text-light);
      font-family: 'Roboto', sans-serif;
      padding: var(--gap);
      line-height: 1.4;
    }
    .brand {
      text-align: center;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--neon);
      text-shadow: 0 0 8px var(--neon), 0 0 16px var(--neon);
      margin-bottom: var(--gap);
      letter-spacing: 2px;
    }
    #wallet-button {
      position: fixed;
      top: var(--gap);
      right: var(--gap);
      padding: .6rem 1.2rem;
      border: 2px solid var(--neon);
      background: transparent;
      color: var(--neon);
      border-radius: var(--radius);
      font-weight: 500;
      cursor: pointer;
      transition: background var(--transition), color var(--transition);
      z-index: 10;
    }
    #wallet-button:hover { background: var(--neon-dim); color: #fff; }
    .banner-wrapper {
      max-width: 300px;
      margin: 0 auto calc(var(--gap) * 1.5);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
    }
    .banner-wrapper img { display: block; width: 100%; }
    .lower-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: var(--gap);
    }
    .box {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      padding: var(--gap);
      display: flex;
      flex-direction: column;
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .box:hover {
      transform: translateY(-6px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    }
    h1 {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--neon);
      text-align: center;
      margin-bottom: 1rem;
      text-shadow: 0 0 4px var(--neon);
    }
    label {
      font-weight: 500;
      margin-bottom: .5rem;
      color: var(--text-light);
    }
    select, input {
      width: 100%;
      padding: .6rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
      color: var(--text-light);
      font-size: 1rem;
      transition: border var(--transition);
    }
    select:focus, input:focus { outline: none; border-color: var(--neon); }
    button {
      padding: .75rem;
      border: 2px solid var(--neon);
      background: transparent;
      color: var(--neon);
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background var(--transition), color var(--transition);
    }
    button:hover { background: var(--neon-dim); color: #fff; }
    .form-group {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .info {
      text-align: center;
      margin: .75rem 0;
      font-size: .95rem;
      color: var(--text-light);
    }
    #status, #stake-status {
      text-align: center;
      margin-top: .5rem;
      min-height: 1.2em;
      font-size: .9rem;
      color: var(--neon);
    }
    .socials {
      text-align: center;
      margin-top: var(--gap);
    }
    .socials a { margin: 0 .5rem; display: inline-block; }
    .socials img {
      width: 28px;
      height: 28px;
      filter: drop-shadow(0 0 4px var(--neon));
    }
  </style>
</head>
<body>
  <div class="brand">InFlow</div>
  <button id="wallet-button">Connect Wallet</button>

  <div class="banner-wrapper">
    <img
      src="https://d5z5gg6ru5enr7l6wb6sdgcjdmju3qtap3eo4du77bry4udg2jiq.ardrive.net/H3PTG9GnSNj9frB9IZhJGxNNwmB-yO4On_hjjlBm0lE"
      alt="InFlow Banner"
    />
  </div>

  <div class="lower-section">
    <!-- Mint Card -->
    <div class="box">
      <h1>Mint NFT</h1>
      <div class="form-group">
        <label for="power-select">Select Power + Price</label>
        <select id="power-select">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
        </select>
        <button id="mint-button">Mint Now</button>
      </div>
      <div id="status">Disconnected</div>
    </div>

    <!-- Staking Card -->
    <div class="box">
      <h1>Stake &amp; Unstake</h1>
      <div class="form-group">
        <label for="stake-select">Your NFTs (Power)</label>
        <select id="stake-select" multiple size="5"></select>
        <button id="stake-button">Stake Selected</button>
      </div>
      <div class="form-group">
        <label for="unstake-select">Staked NFTs</label>
        <select id="unstake-select" multiple size="5"></select>
        <button id="unstake-button">Unstake Selected</button>
      </div>
      <div class="info" id="staked-info">Staked NFTs: 0 | Power: 0</div>
      <div class="info" id="pending-rewards">Rewards: 0 S</div>
      <button id="claim-button">Claim Rewards</button>
      <div id="stake-status"></div>
    </div>

    <!-- Coming Soon Card -->
    <div class="box">
      <h1>Coming Soon</h1>
      <p class="info">Redeem utilities launching shortly!</p>
    </div>
  </div>

  <div class="socials">
    <a href="#" id="docs-link"><img src="PATH_TO_BOOK_ICON" alt="Docs"></a>
    <a href="#" id="x-link"><img src="PATH_TO_X_ICON" alt="X"></a>
    <a href="#" id="telegram-link"><img src="PATH_TO_TELEGRAM_ICON" alt="Telegram"></a>
  </div>

  <script type="module">
    import { ethers } from 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js';

    const NFT_ADDRESS     = '0xBA1636Ba8627D1f1e50FEdaf74F1A54DAAd83EE8';
    const STAKING_ADDRESS = '0x997094ae83Ff75c594F315e39a15E4278d0B55Fe';
    const REQUIRED_CHAIN_ID = 14601;

    // full ABI including approval methods
    const NFT_ABI = [
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},
      {"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"balance","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"operator","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"index","type":"uint256"}],"name":"tokenOfOwnerByIndex","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint8","name":"power","type":"uint8"}],"name":"tokenPower","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint8","name":"power","type":"uint8"}],"name":"feeForPower","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"uint8","name":"power","type":"uint8"}],"name":"mint","outputs":[],"stateMutability":"payable","type":"function"}
    ];

    const STAKING_ABI = [
      'function stake(uint256[])',
      'function unstake(uint256[])',
      'function claimRewards()',
      'function stakedTokensOf(address) view returns (uint256[])',
      'function pendingRewards(address) view returns (uint256)',
      'function totalPowerStaked(address) view returns (uint256)'
    ];

    let provider, signer, account;
    let nftContract, stakingContract;

    // disable mint until network confirmed
    document.getElementById('mint-button').disabled = true;

    async function connectWallet() {
      if (!window.ethereum) {
        alert('Please install a Web3 wallet');
        return;
      }
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      handleAccountsChanged(accounts);
    }

    async function handleAccountsChanged(accounts) {
      if (!accounts || accounts.length === 0) {
        disconnect();
        return;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
      signer   = provider.getSigner();
      account  = await signer.getAddress();

      const net = await provider.getNetwork();
      if (net.chainId !== REQUIRED_CHAIN_ID) {
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x3929' }]
          });
          return handleAccountsChanged(accounts);
        } catch {
          document.getElementById('status').textContent = 'Please switch to Sonic Testnet';
          return;
        }
      }

      document.getElementById('wallet-button').textContent = '…' + account.slice(-4);
      document.getElementById('status').textContent        = 'Connected';
      document.getElementById('mint-button').disabled      = false;

      nftContract     = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);
      stakingContract = new ethers.Contract(STAKING_ADDRESS, STAKING_ABI, signer);

      attachHandlers();
      await updatePowerOptions();
      await refreshUI();
    }

    function disconnect() {
      account = signer = nftContract = stakingContract = null;
      document.getElementById('wallet-button').textContent = 'Connect Wallet';
      document.getElementById('status').textContent        = 'Disconnected';
      document.getElementById('mint-button').disabled      = true;
      document.getElementById('stake-select').innerHTML    = '';
      document.getElementById('unstake-select').innerHTML  = '';
      document.getElementById('staked-info').textContent   = 'Staked NFTs: 0 | Power: 0';
      document.getElementById('pending-rewards').textContent = 'Rewards: 0 S';
      document.getElementById('stake-status').textContent  = '';
    }

    if (window.ethereum) {
      window.ethereum.on('accountsChanged', handleAccountsChanged);
      window.ethereum.on('disconnect', disconnect);
    }

    function attachHandlers() {
      // Mint
      document.getElementById('mint-button').onclick = async () => {
        const p = +document.getElementById('power-select').value;
        try {
          const cost = await nftContract.feeForPower(p);
          const tx   = await nftContract.mint(p, { value: cost });
          document.getElementById('status').textContent = 'Minting…';
          await tx.wait();
          document.getElementById('status').textContent = 'Mint successful!';
        } catch (e) {
          document.getElementById('status').textContent = e.message;
        }
        refreshUI();
      };

      // Stake with approval
      document.getElementById('stake-button').onclick = async () => {
        const ids = Array.from(
          document.getElementById('stake-select').selectedOptions
        ).map(o => +o.value);
        if (!ids.length) return;

        try {
          document.getElementById('stake-status').textContent = 'Checking approval…';
          const approved = await nftContract.isApprovedForAll(account, STAKING_ADDRESS);
          if (!approved) {
            document.getElementById('stake-status').textContent = 'Approving…';
            const approveTx = await nftContract.setApprovalForAll(STAKING_ADDRESS, true);
            await approveTx.wait();
          }

          document.getElementById('stake-status').textContent = 'Staking…';
          const tx = await stakingContract.stake(ids);
          await tx.wait();
          document.getElementById('stake-status').textContent = 'Staked!';
          refreshUI();
        } catch (e) {
          document.getElementById('stake-status').textContent = e.message;
        }
      };

      // Unstake
      document.getElementById('unstake-button').onclick = async () => {
        const ids = Array.from(
          document.getElementById('unstake-select').selectedOptions
        ).map(o => +o.value);
        if (!ids.length) return;

        try {
          document.getElementById('stake-status').textContent = 'Unstaking…';
          const tx = await stakingContract.unstake(ids);
          await tx.wait();
          document.getElementById('stake-status').textContent = 'Unstaked!';
          refreshUI();
        } catch (e) {
          document.getElementById('stake-status').textContent = e.message;
        }
      };

      // Claim
      document.getElementById('claim-button').onclick = async () => {
        try {
          document.getElementById('stake-status').textContent = 'Claiming…';
          const tx = await stakingContract.claimRewards();
          await tx.wait();
          document.getElementById('stake-status').textContent = 'Claimed!';
          refreshUI();
        } catch (e) {
          document.getElementById('stake-status').textContent = e.message;
        }
      };
    }

    async function updatePowerOptions() {
      const sel = document.getElementById('power-select');
      for (let o of sel.options) {
        const p = +o.value;
        const costWei = await nftContract.feeForPower(p);
        const cost = ethers.utils.formatEther(costWei);
        o.textContent = `${p} — $S${cost}`;
      }
    }

    async function refreshUI() {
      try { await populateOwned(); } catch {}
      try { await populateStaked(); } catch {}
      try { await updateStats(); } catch {}
    }

    async function populateOwned() {
      const sel = document.getElementById('stake-select');
      sel.innerHTML = '';
      const bal = await nftContract.balanceOf(account);
      for (let i = 0; i < bal; i++) {
        const id = await nftContract.tokenOfOwnerByIndex(account, i);
        const p  = await nftContract.tokenPower(id);
        const o  = document.createElement('option');
        o.value  = id.toString();
        o.textContent = `#${id} (Power: ${p})`;
        sel.append(o);
      }
    }

    async function populateStaked() {
      const sel = document.getElementById('unstake-select');
      sel.innerHTML = '';
      const staked = await stakingContract.stakedTokensOf(account);
      staked.forEach(id => {
        const o = document.createElement('option');
        o.value = id.toString();
        o.textContent = `#${id}`;
        sel.append(o);
      });
    }

    async function updateStats() {
      const stArr   = await stakingContract.stakedTokensOf(account);
      const power   = await stakingContract.totalPowerStaked(account);
      const rewards = await stakingContract.pendingRewards(account);
      document.getElementById('staked-info').textContent   =
        `Staked NFTs: ${stArr.length} | Power: ${power}`;
      document.getElementById('pending-rewards').textContent =
        `Rewards: ${ethers.utils.formatUnits(rewards,18)} S`;
    }

    document.getElementById('wallet-button').onclick = connectWallet;
  </script>
</body>
</html>
